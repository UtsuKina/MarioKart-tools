<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒãƒƒãƒ—ï¼ˆã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³å¯¾å¿œï¼ä¿å­˜ä»˜ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --sc-bg:#1e66ff; --nisc-bg:#e53935; --itembox-bg:#ff9800;
  }
  *{box-sizing:border-box}
  body{margin:0;display:flex;font-family:sans-serif;background:#fafafa;color:#222;height:100vh;}

  #map-wrap{flex:1;display:flex;flex-direction:row;align-items:stretch;}


#map-area {
  flex: 1;
  position: relative;
  background: #fff;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: grab;
border: 2px solid #000;
}



#map-area.capture-border {
  outline: 3px dashed rgba(0,0,0,0.6);
  outline-offset: -3px;
}


body {
  background: #eee;
}





  #map-area.dragging{cursor:grabbing;}

  #map-inner{
    position:relative;
  overflow: visible;
    transform-origin:center center;
  }
  #map-inner img{
    display:block; max-width:100%; max-height:100%;
    user-select:none; -webkit-user-drag:none; pointer-events:none;
  }
  svg.arrow-layer{
    position:absolute; top:0; left:0; width:100%; height:100%;
    pointer-events:auto;

 overflow: visible;

  }



#arrow-layer {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none; /* çŸ¢å°è‡ªä½“ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’é€šã™ */
}

.arrow-line {
  position: absolute;
  height: 3px; /* ç·šã®å¤ªã• */
  transform-origin: 0 50%;
  pointer-events: auto;

  cursor: move; 

}

.arrow-line::after {
  content: "";
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%) rotate(45deg);
  width: 6px;
  height: 6px;
  border-top: 3px solid currentColor;
  border-right: 3px solid currentColor;
}

/* çŸ¢å°ç·šã®å½“ãŸã‚Šåˆ¤å®šã‚’åºƒã’ã‚‹ï¼ˆé€æ˜ãªé ˜åŸŸï¼‰ */
.arrow-line::before {
  content: "";
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 100%;
  height: 16px;     /* â† ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ç¯„å›²ã‚’åºƒã’ã‚‹ã€‚å¥½ã¿ã«å¿œã˜ã¦èª¿æ•´ï¼ˆä¾‹ï¼š20pxï¼‰ */
  cursor: move;
}



#zoomDisplay {
  position:absolute;
  top:8px;
  right:8px;
  background:rgba(0,0,0,0.6);
  color:#fff;
  font-size:12px;
  padding:2px 6px;
  border-radius:4px;
  pointer-events:none;
}


#sidebar { display:flex; flex-direction:column; }
.sidebar-scroll { flex:1; overflow-y:auto; }



  #sidebar{
    width:220px; border-left:1px solid #ddd; background:#fff; overflow-y:auto;
  }
  #sidebar h3{margin:10px 8px 6px;font-size:13px;color:#444}

  .icons{display:flex;flex-wrap:wrap;gap:6px;padding:0 8px 8px;}

.icon {
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:12px;   /* ãƒãƒƒãƒ—ã«åˆã‚ã›ã‚‹ */
  color:#fff;
  margin:0;         /* ä½™ç™½ã‚’æ¶ˆã™ */
  cursor:grab;
  user-select:none;




}

  .sc{border-radius:50%;background:var(--sc-bg);}
  .nisc{border-radius:50%;background:var(--nisc-bg);}
  .itembox{border-radius:6px;background:var(--itembox-bg);}


.icon.item {
  width:24px;
  height:24px;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.placed.item {
  width:24px;
  height:24px;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}


/* ãƒãƒƒãƒ—ä¸Šã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸€å›ã‚Šå°ã•ãã—ã€ä¸­å¿ƒåŸºæº–ã«ã™ã‚‹ */

.text-label {
  position: absolute;
  min-width: 40px;
  min-height: 20px;
  font-size: 14px;
  background: rgba(255,255,255,0.7);
  border: 1px solid #ccc;
  padding: 2px 4px;
  border-radius: 3px;
  cursor: move;


  white-space: nowrap;
  outline: none;
  user-select: text;


}


.placed {
  position:absolute;
  cursor:move;
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;    /* â˜…è¿½åŠ  */
  line-height:24px;     /* â˜…è¿½åŠ ï¼šé«˜ã•ã«åˆã‚ã›ã‚‹ */
  font-weight:800;
  font-size:12px;
  color:#fff;
  transform: translate(-50%, -50%);
}



  .placed.sc{background:var(--sc-bg);border-radius:50%;}
  .placed.nisc{background:var(--nisc-bg);border-radius:50%;}
  .placed.itembox{background:var(--itembox-bg);border-radius:6px;}

  #legend{margin:8px;padding:8px;border-top:1px solid #eee;font-size:12px;background:rgba(255,255,255,.9)}
  .hint{font-size:11px;color:#666;margin-top:6px}


  .arrow-hit{stroke:black; stroke-opacity:0; stroke-width:32;   stroke-linecap:round; pointer-events:stroke;}
  .arrow-vis{stroke-width:3; pointer-events:none;}
  .arrow-group{cursor:move;}
  .start-dot{
    position:absolute;width:10px;height:10px;border-radius:50%;
    background:#000;transform:translate(-50%,-50%); pointer-events:none; opacity:.6;



  }


.hide-icons .placed,
.hide-icons .text-label,
.hide-icons .arrow-line {
  visibility: hidden;   /* â† ã“ã‚Œã§éè¡¨ç¤ºã€‚ä½ç½®ã¯ä¿æŒã•ã‚Œã‚‹ */
}

/* é¸æŠä¸­ã®çŸ¢å°ãƒœã‚¿ãƒ³ã‚’åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹ */
.arrow-btn.active-arrow {
  background-color: #ccc;
  box-shadow: inset 0 0 4px rgba(0,0,0,0.4);
}



button { 
  margin: 4px 2px;  /* â† 8px ã‚’ 4px ã«ã™ã‚‹ã¨é–“éš”ãŒåŠåˆ†ã«ãªã‚‹ */
  padding:6px 12px;
  font-size:13px;
  border:1px solid #888;
  border-radius:6px;
  background:#eee;
  cursor:pointer;
  height:28px;
  line-height:1;
}


#resizer-map {
  width: 6px;
  cursor: col-resize;
  background: #ccc;
  transition: background 0.2s;
}
#resizer-map:hover {
  background: #999;
}



</style>
</head>
<body>
<div id="map-wrap">



  <div id="map-area">
    <div id="map-inner">
      <img id="bgimg" src="" alt="map">
     <div id="arrow-layer"></div>
    </div>

<div id="zoomDisplay">1.0x</div>

  </div>

  <div id="resizer-map"></div>

  <aside id="sidebar">
<div class="sidebar-top">

<!-- æ—¢å­˜ã®ãƒœã‚¿ãƒ³ç¾¤ã®è¿‘ãã«è¿½åŠ  -->
<div style="padding:8px;">
  <div>ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º</div>
  <input type="range" id="iconSizeRange" min="0.5" max="2.0" step="0.1" value="1.0">
  <span id="iconSizeValue">1.0x</span>
</div>
 </div>

  <div class="sidebar-scroll">


    <h3>SC</h3><div id="sc-icons" class="icons"></div>
    <h3>NISC</h3><div id="nisc-icons" class="icons"></div>
    <h3>ItemBox</h3><div id="item-icons" class="icons"></div>

<h3>Item</h3><div id="items" class="icons"></div>

  </div>


  <div class="sidebar-bottom">

<button id="textBtn" draggable="true">T</button>

<button id="blackArrowBtn" title="é»’çŸ¢å°">â†—</button>
<button id="blueArrowBtn" title="é’çŸ¢å°" style="color:blue;">â†—</button>
<button id="redArrowBtn" title="èµ¤çŸ¢å°" style="color:red;">â†—</button>

<button id="resetZoomBtn">1.0x</button>

<button id="fitBtn">æœ€é©ã‚µã‚¤ã‚º</button>


<button id="toggleIconsBtn">ã‚¢ã‚¤ã‚³ãƒ³éè¡¨ç¤º</button>


<button id="undoBtn">â†»</button>
<button id="redoBtn">â†º</button>
<button id="clearBtn">ğŸ—‘ï¸å…¨å‰Šé™¤</button>
<button id="exportBtn">ğŸ’¾PNGä¿å­˜</button>

<button id="replaceItemBoxBtn">ItemBox â†’ IBå¤‰æ›</button>


    <div id="legend">
      <div>ãƒ»Tãƒœã‚¿ãƒ³ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§æ–‡å­—å…¥åŠ›ã€‚ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å†ç·¨é›†</div>
      <div>ãƒ»å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤</div>
      <div>ãƒ»ãƒãƒƒãƒ—ã‚’2å›ã‚¯ãƒªãƒƒã‚¯ã§çŸ¢å°ã®å§‹ç‚¹ã¨çµ‚ç‚¹ã‚’æ±ºå®š</div>
      <div>ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•</div>
      <div>ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒãƒƒãƒ—ç§»å‹•</div>
      <div>ãƒ»ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆ0.5xã€œ3xï¼‰</div>
    </div>

 </div>

  </aside>
</div>

<script>
const params=new URLSearchParams(location.search);
const START=params.get("start")||""; const END=params.get("end")||"";
const STORAGE_KEY=`map_${START}_${END}`;

const mapArea=document.getElementById('map-area');
const mapInner=document.getElementById('map-inner');
const img=document.getElementById('bgimg');

const arrowLayer=document.getElementById('arrow-layer');

const sidebar=document.getElementById('sidebar');


let currentArrowColor = "black"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

// çŸ¢å°ãƒœã‚¿ãƒ³ä¸€è¦§ï¼ˆ3è‰²ï¼‰
const arrowButtons = [
  {id: "blackArrowBtn", color: "black"},
  {id: "redArrowBtn",   color: "red"},
  {id: "blueArrowBtn",  color: "blue"}
];

// å„ãƒœã‚¿ãƒ³ã«å…±é€šã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
arrowButtons.forEach(btn=>{
  const el = document.getElementById(btn.id);
  el.classList.add("arrow-btn");
  el.addEventListener("click", ()=>{
    currentArrowColor = btn.color;

    // ä¸€åº¦å…¨ã¦ãƒªã‚»ãƒƒãƒˆ
    arrowButtons.forEach(b=>{
      document.getElementById(b.id).classList.remove("active-arrow");
    });

    // é¸æŠä¸­ãƒœã‚¿ãƒ³ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ä¸
    el.classList.add("active-arrow");
  });
});

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆé»’çŸ¢å°ï¼‰ã‚’é¸æŠçŠ¶æ…‹ã«
document.getElementById("blackArrowBtn").classList.add("active-arrow");



let zoom=1, panX=0, panY=0; // è¡¨ç¤ºå¤‰æ›ã®çŠ¶æ…‹
let dragTarget=null, offsetX=0, offsetY=0;
let isDraggingSomething=false;
let arrowStartPoint=null, startDot=null;


// åŸºæº–ã‚µã‚¤ã‚ºã¯å›ºå®š
const baseIconSizes = {
  SC: 24,
  NISC: 24,
  ItemBox: 24,
  item: 24
};

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¤‰ã‚ã‚‹å€ç‡ï¼ˆåˆæœŸå€¤1.0ï¼‰
let iconScale = 1.0;

function applyIconSizesToDOM(){
  document.querySelectorAll('.placed').forEach(el=>{
    const t = el.dataset.type;
    const base = baseIconSizes[t] || 24;
    const size = Math.round(base * iconScale);
    el.style.width = size + 'px';
    el.style.height = size + 'px';
  });

  document.querySelectorAll('.icon').forEach(el=>{
    const t = el.dataset.type;
    if(!t) return;
    const base = baseIconSizes[t] || 24;
    const size = Math.round(base * iconScale);
    el.style.width = size + 'px';
    el.style.height = size + 'px';
  });
}

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯å¤–ã§1å›ã ã‘
document.getElementById('iconSizeRange').addEventListener('input', e=>{
  iconScale = parseFloat(e.target.value);
  applyIconSizesToDOM();
  localStorage.setItem(`iconScale_${STORAGE_KEY}`, iconScale); // â†ã‚³ãƒ¼ã‚¹ã”ã¨ä¿å­˜ï¼
  document.getElementById("iconSizeValue").textContent = iconScale.toFixed(1) + "x";
});





/* ãƒ‘ãƒ¬ãƒƒãƒˆåˆæœŸåŒ– */
function createPalette(cid,type,cls){
  const c=document.getElementById(cid); c.innerHTML="";
  for(let i=1;i<=12;i++){
    const d=document.createElement("div");
    d.className="icon "+cls;
    d.draggable=true; d.dataset.type=type; d.dataset.num=i; d.textContent=i;
    c.appendChild(d);
  }
}
createPalette("sc-icons","SC","sc");
createPalette("nisc-icons","NISC","nisc");
createPalette("item-icons","ItemBox","itembox");




// â˜…ã“ã“ã§ãƒ‘ãƒ¬ãƒƒãƒˆå´ã«ã‚‚ã‚µã‚¤ã‚ºè£œæ­£ã‚’é©ç”¨
applyIconSizesToDOM();


// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºå€ç‡ã‚’å¾©å…ƒï¼ˆã‚³ãƒ¼ã‚¹ã”ã¨ï¼‰
const storedScale = localStorage.getItem(`iconScale_${STORAGE_KEY}`);
if (storedScale) {
  iconScale = parseFloat(storedScale);
  document.getElementById("iconSizeRange").value = iconScale;
  document.getElementById("iconSizeValue").textContent = iconScale.toFixed(1) + "x";
  applyIconSizesToDOM();
}



</script>
<script src="courses.js"></script>
<script>
const bg=(typeof getBackground==="function"?getBackground(START,END):"")||(typeof defaultBackground!=="undefined"?defaultBackground:"");
if(bg) img.src=bg;


</script>
<script>

/* ===== ãƒ‘ãƒ³ãƒ»ã‚ºãƒ¼ãƒ ç®¡ç† ===== */
function applyTransform(){
  mapInner.style.transform=`translate(${panX}px,${panY}px) scale(${zoom})`;
 document.getElementById("zoomDisplay").textContent = zoom.toFixed(1) + "x";
}
mapArea.addEventListener('wheel',e=>{
  if(e.target.closest('#sidebar')) return;
  e.preventDefault();
  const scale=e.deltaY<0?1.1:0.9;
  zoom*=scale; zoom=Math.max(0.5,Math.min(zoom,3));
  applyTransform();
});
let panDragging=false, panPrev={x:0,y:0};
  mapArea.addEventListener('mousedown',e=>{
   if(e.button !== 1) return; // ä¸­ãƒœã‚¿ãƒ³ä»¥å¤–ã¯ç„¡è¦–
   if(e.target.closest('#sidebar')) return; // ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸Šã¯ç„¡è¦–
   panDragging=true; panPrev={x:e.clientX,y:e.clientY};
   mapArea.classList.add('dragging');
   e.preventDefault(); // ä¸­ã‚¯ãƒªãƒƒã‚¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‹•ä½œã‚’æŠ‘åˆ¶
});
document.addEventListener('mousemove',e=>{
  if(!panDragging) return;
  const dx=e.clientX-panPrev.x, dy=e.clientY-panPrev.y;
  panX+=dx; panY+=dy;
  panPrev={x:e.clientX,y:e.clientY};
  applyTransform();
});
document.addEventListener('mouseup',()=>{
  panDragging=false; mapArea.classList.remove('dragging');
});
document.getElementById('resetZoomBtn').addEventListener('click',()=>{
  zoom=1; panX=0; panY=0; applyTransform();
});


// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«å…¨çŸ¢å°ã®ä½ç½®ã‚’å†è¨ˆç®—
window.addEventListener('resize', ()=>{
  document.querySelectorAll('.arrow-line').forEach(applyArrowLinePosition);
});





/* ===== D&Dï¼ˆsidebar â†’ map-inner ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰ ===== */
mapArea.addEventListener('dragover', e => e.preventDefault());
mapArea.addEventListener('drop', e => {
  e.preventDefault();
  const type=e.dataTransfer.getData("type");
  const num =e.dataTransfer.getData("num");
  if(!type || !num) return;

  // â˜… Item ä»¥å¤–ã¯é‡è¤‡ç¦æ­¢
  if (type !== 'item' &&
      mapInner.querySelector(`.placed[data-type="${type}"][data-num="${num}"]`)) {
    return;
  }

  const rect=mapInner.getBoundingClientRect();
  const xp=((e.clientX-rect.left)/rect.width )*100;
  const yp=((e.clientY-rect.top )/rect.height)*100;

  const icon=createPlacedIcon(type,num,xp,yp);
  mapInner.appendChild(icon);


// ã“ã“ã§å³ã‚µã‚¤ã‚ºèª¿æ•´
applyIconSizesToDOM();



  // â˜… Item ä»¥å¤–ã¯ãƒ‘ãƒ¬ãƒƒãƒˆã‹ã‚‰æ¶ˆã™
  if (type !== 'item') {
    removeFromPalette(type,num);
  }

  saveState();
});


// ---- ãƒ†ã‚­ã‚¹ãƒˆ(Tãƒœã‚¿ãƒ³)ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ----
sidebar.addEventListener('dragstart', e=>{
  if(e.target.id === "textBtn"){
    e.dataTransfer.setData("type", "text");
  }
});

mapArea.addEventListener('drop', e=>{
  e.preventDefault();
  const type = e.dataTransfer.getData("type");
  if(type === "text"){
    const rect = mapInner.getBoundingClientRect();
    const xp=((e.clientX-rect.left)/rect.width )*100;
    const yp=((e.clientY-rect.top )/rect.height)*100;

const label = createTextLabel("", xp, yp, "#000", true);



    saveState();
    return;
  }
  // æ—¢å­˜ã®ã‚¢ã‚¤ã‚³ãƒ³å‡¦ç†ã¯ãã®ã¾ã¾æ®‹ã™
});




let iconsHidden = false;
const toggleBtn = document.getElementById("toggleIconsBtn");

toggleBtn.addEventListener("click", ()=>{
  iconsHidden = !iconsHidden;

  if(iconsHidden){
    mapInner.classList.add("hide-icons");
  }else{
    mapInner.classList.remove("hide-icons");
  }

  toggleBtn.textContent = iconsHidden ? "ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º" : "ã‚¢ã‚¤ã‚³ãƒ³éè¡¨ç¤º";
});







// ã‚¢ãƒ³ãƒ‰ã‚¥/ãƒªãƒ‰ã‚¥
let history = [], historyIndex = -1;





document.getElementById("undoBtn").addEventListener("click", ()=>{
  if(historyIndex>0){
    historyIndex--;
    loadStateFromString(history[historyIndex]);
    localStorage.setItem(STORAGE_KEY, history[historyIndex]); // â† ã“ã‚Œè¿½åŠ 
  }
});
document.getElementById("redoBtn").addEventListener("click", ()=>{
  if(historyIndex < history.length-1){
    historyIndex++;
    loadStateFromString(history[historyIndex]);
    localStorage.setItem(STORAGE_KEY, history[historyIndex]); // â† ã“ã‚Œè¿½åŠ 
  }
});






// æœ€é©ã‚µã‚¤ã‚ºãƒœã‚¿ãƒ³
let fitZoom = 1;
img.addEventListener('load', ()=>{
  const areaRect = mapArea.getBoundingClientRect();
  fitZoom = Math.min(areaRect.width / img.naturalWidth, areaRect.height / img.naturalHeight);
});
document.getElementById("fitBtn").addEventListener("click", ()=>{
  zoom = fitZoom * 0.95;
  panX=0; panY=0;
  applyTransform();
});






// PNGå‡ºåŠ›
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const prevBorder = mapArea.style.border;
  mapArea.style.border = "none";  // ä¸€æ™‚çš„ã«æ¶ˆã™
  html2canvas(mapArea, {useCORS:true, backgroundColor:null}).then(canvas=>{
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = "map.png";
    a.click();
  }).finally(()=>{
    mapArea.style.border = prevBorder; // å…ƒã«æˆ»ã™
  });
});





sidebar.addEventListener('dragstart',e=>{
  if(e.target.classList.contains("icon")){
    e.dataTransfer.setData("type",e.target.dataset.type);
    e.dataTransfer.setData("num", e.target.dataset.num);
  }
});



/* ===== ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆãƒ»ç§»å‹•ãƒ»å‰Šé™¤ ===== */
function createPlacedIcon(type,num,xPercent,yPercent){
  const icon=document.createElement("div");
  icon.classList.add("placed", type.toLowerCase());
  icon.dataset.type=type;
  icon.dataset.num =num;

  if(type === "item"){
    icon.style.backgroundImage = `url('item_images/${num}.png')`;
    icon.style.backgroundSize = 'contain';
    icon.style.backgroundRepeat = 'no-repeat';
    icon.style.backgroundPosition = 'center';
  }else{
    icon.textContent = num;
  }

  setIconPos(icon, xPercent, yPercent);
  icon.addEventListener('mousedown',startDragIcon);

  icon.addEventListener('contextmenu',e=>{
    e.preventDefault();
    icon.remove();
    if (type !== 'item') restoreToPalette(type,num);
    saveState();
  });

  // â˜… ã“ã“ã§ã‚µã‚¤ã‚ºã‚’ç¾åœ¨ã® scale ã«åˆã‚ã›ã‚‹
  applyIconSizesToDOM();

  return icon;
}


/* ===== çµ±ä¸€ï¼šä¿å­˜ï¼å¾©å…ƒï¼ˆundo/redo + localStorageï¼‰ ===== */


function saveState(){
  const state = {
    icons: [...mapInner.querySelectorAll('.placed')].map(el=>({
      type: el.dataset.type,
      num: el.dataset.num,
      xp: +el.dataset.xp,
      yp: +el.dataset.yp
    })),



arrowLines: [...document.querySelectorAll('.arrow-line')].map(d => ({
  x1p:+d.dataset.x1p, y1p:+d.dataset.y1p,
  x2p:+d.dataset.x2p, y2p:+d.dataset.y2p,
  color:d.style.backgroundColor
})),




texts: [...mapInner.querySelectorAll('.text-label')].map(el=>({
  xp:+el.dataset.xp,   // â† dataset ã® % ã‚’å¿…ãšä½¿ã†
  yp:+el.dataset.yp,
  html: el.innerHTML   // â† innerText â†’ innerHTML
})),



  };

  const s = JSON.stringify(state);

  // ç›´å‰ã®å±¥æ­´ã¨åŒã˜ãªã‚‰é‡è¤‡ push ã—ãªã„ï¼ˆç„¡é§„ãªå±¥æ­´å¢—åŠ é˜²æ­¢ï¼‰
  if(historyIndex >= 0 && history[historyIndex] === s) {
    localStorage.setItem(STORAGE_KEY, s);
    return;
  }

  history = history.slice(0, historyIndex+1);
  history.push(s);
  historyIndex++;
  // ç¾åœ¨çŠ¶æ…‹ã¯ localStorage ã«ã‚‚å…¥ã‚Œã¦ãŠãï¼ˆãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿æ™‚ã®å¾©å…ƒç”¨ï¼‰
  localStorage.setItem(STORAGE_KEY, s);
}

/* loadStateFromString: å±¥æ­´æ–‡å­—åˆ—ã‹ã‚‰å¾©å…ƒï¼ˆundo/redo ç”¨ã«ä½¿ã†ï¼‰ */
function loadStateFromString(stateStr){
  // æ—¢å­˜ã®é…ç½®ã‚’æ¶ˆã™
  [...mapInner.querySelectorAll('.placed')].forEach(el=>el.remove());

[...document.querySelectorAll('.arrow-line')].forEach(g=>g.remove());


  [...mapInner.querySelectorAll('.text-label')].forEach(t=>t.remove());

  if(!stateStr) return;
  try{
    const s = JSON.parse(stateStr);

    for(const it of (s.icons||[])){
      const el = createPlacedIcon(it.type, it.num, it.xp, it.yp);
      mapInner.appendChild(el);
      if (it.type !== 'item') removeFromPalette(it.type, it.num);
    }

for(const a of (s.arrowLines || s.arrows || [])){
  createArrowLine(a.x1p, a.y1p, a.x2p, a.y2p, a.color || "black");
}


for(const t of (s.texts||[])){
  const div = createTextLabel("", t.xp, t.yp); // ä½ç½®ã ã‘æŒ‡å®šã—ã¦ä½œæˆ
  div.innerHTML = t.html || "";                // â† ä¿å­˜æ™‚ã« innerHTML ã‚’æŒãŸã›ãŸã®ã§å¾©å…ƒ
}




  }catch(e){
    console.warn("loadStateFromString parse error", e);
  }
}

/* loadState: ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã® localStorage ã‹ã‚‰ã®å¾©å…ƒ + history åˆæœŸåŒ– */
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  history = []; historyIndex = -1;

  if(!raw) return;
  try{
    const s = JSON.parse(raw);

    // æ—¢å­˜ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¿µã®ãŸã‚ï¼‰
    [...mapInner.querySelectorAll('.placed')].forEach(el=>el.remove());
[...document.querySelectorAll('.arrow-line')].forEach(g=>g.remove());

    [...mapInner.querySelectorAll('.text-label')].forEach(t=>t.remove());

    for(const it of (s.icons||[])){
      const el = createPlacedIcon(it.type, it.num, it.xp, it.yp);
      mapInner.appendChild(el);
      if (it.type !== 'item') removeFromPalette(it.type, it.num);
    }

   for(const a of (s.arrowLines || s.arrows || [])){
  createArrowLine(a.x1p, a.y1p, a.x2p, a.y2p, a.color || "black");
}


for(const t of (s.texts||[])){
  const div = createTextLabel("", t.xp, t.yp); // ä½ç½®ã ã‘æŒ‡å®šã—ã¦ä½œæˆ
  div.innerHTML = t.html || "";                // â† ä¿å­˜æ™‚ã« innerHTML ã‚’æŒãŸã›ãŸã®ã§å¾©å…ƒ
}



    // ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºãŒä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°å¾©å…ƒ
if(s.iconScale !== undefined){
  iconScale = s.iconScale;
  document.getElementById("iconSizeRange").value = iconScale;
  document.getElementById("iconSizeValue").textContent = iconScale.toFixed(1) + "x";

}
applyIconSizesToDOM();





    // history åˆæœŸåŒ–ï¼ˆundo ã®åŸºç‚¹ï¼‰
const stateStr = JSON.stringify({
  icons: s.icons || [],
  arrowLines: s.arrowLines || s.arrows || [],
  texts: s.texts || []
});

    history = [stateStr];
    historyIndex = 0;

  }catch(e){
    console.warn('loadState parse error', e);
  }
}





function setIconPos(el, xp, yp){
  el.style.left = xp + "%";
  el.style.top  = yp + "%";
  el.dataset.xp = xp;
  el.dataset.yp = yp;
}
function startDragIcon(e){
if (e.button !== 0) return; // â˜…å·¦ã‚¯ãƒªãƒƒã‚¯ä»¥å¤–ã¯ç„¡è¦–
  dragTarget=e.target;
  isDraggingSomething=true;
  const rect=dragTarget.getBoundingClientRect();
  offsetX=e.clientX-rect.left;
  offsetY=e.clientY-rect.top;
  document.addEventListener('mousemove',onDragIcon);
  document.addEventListener('mouseup',endDragIcon);
}
function onDragIcon(e){
  if(!dragTarget)return;
  e.preventDefault();
  const rect=mapInner.getBoundingClientRect();
  const x=((e.clientX-rect.left-offsetX)/rect.width )*100;
  const y=((e.clientY-rect.top -offsetY)/rect.height)*100;
  setIconPos(dragTarget, x, y);
}
function endDragIcon(){
  document.removeEventListener('mousemove',onDragIcon);
  document.removeEventListener('mouseup',endDragIcon);
  setTimeout(()=>{ isDraggingSomething=false; saveState(); },50);
}

function getMapPercentPoint(e) {
  const rect = mapInner.getBoundingClientRect();
  return {
    xp: ((e.clientX - rect.left) / rect.width) * 100,
    yp: ((e.clientY - rect.top ) / rect.height) * 100
  };
}


/* --- ã‚¢ã‚¤ãƒ†ãƒ ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ä½œæˆï¼ˆæ—¢å­˜ã® #items ã«è¿½åŠ ï¼‰--- */
(function createItemPalette(){
  const itemList = [
    {name:'kino1', title:'ã‚­ãƒ1'},
    {name:'kino2', title:'ã‚­ãƒ2'},
    {name:'kino3', title:'ã‚­ãƒ3'},
    {name:'star',  title:'ã‚¹ã‚¿ãƒ¼'},
    {name:'Gkino', title:'é‡‘ã‚­ãƒ'},
    {name:'killer',title:'ã‚­ãƒ©ãƒ¼'},   // â† killer.png
    {name:'hane',  title:'ãƒãƒ'},
    {name:'thunder', title:'ã‚µãƒ³ãƒ€ãƒ¼'},
    {name:'IB',    title:'ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒƒã‚¯ã‚¹'}, // â† IB.png ã«ãƒªãƒãƒ¼ãƒ æ¸ˆã¿
ã€€ã€€{name:'DoubleIB',    title:'ãƒ€ãƒ–ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒƒã‚¯ã‚¹'},
    {name:'food',  title:'ãƒ•ãƒ¼ãƒ‰'}   // â† food.png


  ];

  const container = document.getElementById('items');
  if(!container) return;

  container.innerHTML = '';

  itemList.forEach(it=>{
    const d = document.createElement('div');
    d.className = 'icon item';
    d.dataset.type = 'item';
    d.dataset.num  = it.name;
    d.title = it.title;
    d.style.backgroundImage = `url('item_images/${it.name}.png')`;
    d.style.backgroundSize = 'contain';
    d.style.backgroundRepeat = 'no-repeat';
    d.style.backgroundPosition = 'center';
    d.setAttribute('draggable','true');
    container.appendChild(d);
  });
})();


/* ===== ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ©Ÿèƒ½ ===== */
mapArea.addEventListener("dblclick", e => {
  if(e.target.closest("#sidebar")) return; // ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸Šã¯ç„¡è¦–
  if(e.target.closest(".placed") || e.target.closest(".text-label")) return; // ã‚¢ã‚¤ã‚³ãƒ³ã‚„æ—¢å­˜ãƒ©ãƒ™ãƒ«ã¯ç„¡è¦–

  const {xp, yp} = getMapPercentPoint(e);
    createTextLabel("ãƒ†ã‚­ã‚¹ãƒˆ", xp, yp);
  saveState();
});




function createTextLabel(text, xPercent, yPercent, color="#000", autoFocus=false) {
  const div = document.createElement("div");
  div.className = "text-label";
  div.textContent = text || "";
  div.dataset.xp = +xPercent;
  div.dataset.yp = +yPercent;
  div.style.color = color;

  // åˆæœŸä½ç½®
  setIconPos(div, +xPercent, +yPercent);

  // ç§»å‹•
  div.addEventListener("mousedown", e => {
    if (e.button !== 0) return;
    dragTarget = div;
    isDraggingSomething = true;
    const rect = dragTarget.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    document.addEventListener("mousemove", onDragIcon);
    document.addEventListener("mouseup", endDragIcon);
  });

  // å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤
  div.addEventListener("contextmenu", e => {
    e.preventDefault();
    div.remove();
    saveState();
  });

  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†å†é–‹
  div.addEventListener("dblclick", e => {
    e.stopPropagation();
    div.contentEditable = true;
    div.focus();
  });

  // Enterã§ç¢ºå®šã€Shift+Enterã¯æ”¹è¡Œ
  div.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      div.contentEditable = false;
      div.blur();
      saveState();
    }
  });

  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚ŒãŸã‚‰ç¢ºå®š
  div.addEventListener("blur", () => {
    if (div.isContentEditable) {
      div.contentEditable = false;
      saveState();
    }
  });

  mapInner.appendChild(div);

  // â˜… æ–°è¦ä½œæˆã®æ™‚ã ã‘ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  if(autoFocus){
    div.contentEditable = true;
    setTimeout(() => div.focus(), 0);
  }

  return div;
}




/* ===== çŸ¢å°ç®¡ç† ===== */
mapArea.addEventListener('click', e=>{
  if(isDraggingSomething) return;
  if(e.target.closest('#sidebar')) return;
  if(e.target.closest('.placed')) return;

  // â˜…ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³è£œæ­£ã—ã¦å–å¾—
  const {xp, yp} = getMapPercentPoint(e);

  if(!arrowStartPoint){
    arrowStartPoint={xp, yp};
    startDot=document.createElement('div');
    startDot.className='start-dot';
    startDot.style.left=xp+"%"; startDot.style.top=yp+"%";
    mapInner.appendChild(startDot);
  }else{

   createArrowLine(arrowStartPoint.xp, arrowStartPoint.yp, xp, yp);


    arrowStartPoint=null;
    if(startDot){ startDot.remove(); startDot=null; }
    saveState();
  }
});








function createArrowLine(x1p, y1p, x2p, y2p, color = currentArrowColor) {
  const div = document.createElement("div");
  div.className = "arrow-line";
  div.style.backgroundColor = color;
  div.style.color = color;
  div.dataset.x1p = x1p;
  div.dataset.y1p = y1p;
  div.dataset.x2p = x2p;
  div.dataset.y2p = y2p;

  applyArrowLinePosition(div);

  // å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤
  div.addEventListener("contextmenu", e => {
    e.preventDefault();
    div.remove();
    saveState();
  });

  // â–¼ å·¦ã‚¯ãƒªãƒƒã‚¯ãƒ‰ãƒ©ãƒƒã‚°ã§çŸ¢å°å…¨ä½“ã‚’ç§»å‹•
  let dragging = false;
  let prev = null;

  div.addEventListener("mousedown", e => {
    if (e.button !== 0) return; // å·¦ã‚¯ãƒªãƒƒã‚¯ã®ã¿
    dragging = true;
    isDraggingSomething = true;
    prev = getRelPercentPoint(e);
    e.preventDefault();
  });

  document.addEventListener("mousemove", e => {
    if (!dragging) return;
    const p = getRelPercentPoint(e);
    const dx = p.x - prev.x;
    const dy = p.y - prev.y;

    // datasetåº§æ¨™ã‚’æ›´æ–°
    div.dataset.x1p = +div.dataset.x1p + dx;
    div.dataset.y1p = +div.dataset.y1p + dy;
    div.dataset.x2p = +div.dataset.x2p + dx;
    div.dataset.y2p = +div.dataset.y2p + dy;

    prev = p;
    applyArrowLinePosition(div);
  });

  document.addEventListener("mouseup", () => {
    if (dragging) {
      dragging = false;
      setTimeout(() => {
        isDraggingSomething = false;
        saveState();
      }, 50);
    }
  });

  document.getElementById("arrow-layer").appendChild(div);
  return div;
}


function applyArrowLinePosition(div) {
  const baseW = mapInner.clientWidth;
  const baseH = mapInner.clientHeight;

  const x1 = (div.dataset.x1p / 100) * baseW;
  const y1 = (div.dataset.y1p / 100) * baseH;
  const x2 = (div.dataset.x2p / 100) * baseW;
  const y2 = (div.dataset.y2p / 100) * baseH;

  const dx = x2 - x1;
  const dy = y2 - y1;
  const len = Math.sqrt(dx * dx + dy * dy);
  const angle = Math.atan2(dy, dx) * 180 / Math.PI;

  div.style.left = x1 + "px";
  div.style.top = y1 + "px";
  div.style.width = len + "px";
  div.style.transform = `rotate(${angle}deg)`;
}





function getRelPercentPoint(e){
 const rect = mapInner.getBoundingClientRect(); // â˜…ä¿®æ­£
  return { x: ((e.clientX - rect.left) / rect.width ) * 100,
           y: ((e.clientY - rect.top  ) / rect.height) * 100 };
}





/* ===== ãƒ‘ãƒ¬ãƒƒãƒˆè¡¨ç¤ºåˆ¶å¾¡ ===== */
function removeFromPalette(type,num){
  const el=sidebar.querySelector(`.icon[data-type="${type}"][data-num="${num}"]`);
  if(el) el.style.visibility="hidden";
}
function restoreToPalette(type,num){
  const el=sidebar.querySelector(`.icon[data-type="${type}"][data-num="${num}"]`);
  if(el) el.style.visibility="visible";
}
function restoreAllPalette(){
  sidebar.querySelectorAll('.icon').forEach(el=>el.style.visibility="visible");
}








document.getElementById('clearBtn').addEventListener('click',()=>{
  [...mapInner.querySelectorAll('.placed')].forEach(el=>el.remove());
[...document.querySelectorAll('.arrow-line')].forEach(g=>g.remove());
  [...mapInner.querySelectorAll('.text-label')].forEach(el=>el.remove()); 
  restoreAllPalette();
  localStorage.removeItem(STORAGE_KEY);
});


img.addEventListener('load', ()=>{
  const iw = img.naturalWidth;
  const ih = img.naturalHeight;

// çŸ¢å°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç”»åƒã¨åŒã˜å¤§ãã•ã«å›ºå®šï¼ˆdiv ã® style ã‚’ä½¿ã†ï¼‰
arrowLayer.style.width  = iw + "px";
arrowLayer.style.height = ih + "px";


  // æœ€å¤§ãƒ•ã‚£ãƒƒãƒˆå€ç‡ã‚’è¨ˆç®—
  const areaRect = mapArea.getBoundingClientRect();
  const fitZoom = Math.min(areaRect.width / iw, areaRect.height / ih);

  zoom = fitZoom * 0.95;
  panX = 0;
  panY = 0;

  applyTransform();
  loadState();

});


sidebar.addEventListener('dragstart',e=>{
  if(e.target.classList.contains('icon')){
    e.dataTransfer.setData('type', e.target.dataset.type);
    e.dataTransfer.setData('num',  e.target.dataset.num);
  }
});


/* ===== ItemBox â†’ IBç½®ãæ›ãˆãƒœã‚¿ãƒ³ ===== */
document.getElementById("replaceItemBoxBtn").addEventListener("click", ()=>{
  const boxes = [...mapInner.querySelectorAll('.placed.itembox')];
  if (!boxes.length) return;

  // å±¥æ­´ã«ä¿å­˜ï¼ˆUndoå¯¾å¿œï¼‰
  saveState();

  boxes.forEach(box => {
    const xp = +box.dataset.xp;
    const yp = +box.dataset.yp;
    const num = box.dataset.num;

    // IBã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
    const ib = createPlacedIcon("item", "IB", xp, yp);
    mapInner.appendChild(ib);

    restoreToPalette("ItemBox", num);
    box.remove();
  });

  // æ›´æ–°å¾Œã®çŠ¶æ…‹ã‚‚å±¥æ­´ã«è¨˜éŒ²
  saveState();
});



const resizerMap = document.getElementById("resizer-map");
let startX2 = 0, startWidth2 = 0;
resizerMap.addEventListener("pointerdown", e => {
  e.preventDefault();
  startX2 = e.clientX;
  startWidth2 = sidebar.offsetWidth;
  resizerMap.setPointerCapture(e.pointerId);
  document.body.style.cursor = "col-resize";
});
resizerMap.addEventListener("pointermove", e => {
  if (!resizerMap.hasPointerCapture(e.pointerId)) return;
  const dx = startX2 - e.clientX;
  const newW = Math.min(Math.max(startWidth2 + dx, 150), 400);
  sidebar.style.width = newW + "px";
});
resizerMap.addEventListener("pointerup", e => {
  if (resizerMap.hasPointerCapture(e.pointerId))
    resizerMap.releasePointerCapture(e.pointerId);
  document.body.style.cursor = "";
  localStorage.setItem("mapSidebarWidth", sidebar.offsetWidth);
});
// å†èª­ã¿è¾¼ã¿æ™‚ã«å¹…å¾©å…ƒ
const savedSidebarWidth = localStorage.getItem("mapSidebarWidth");
if (savedSidebarWidth) sidebar.style.width = savedSidebarWidth + "px";


</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


</body>
</html>
